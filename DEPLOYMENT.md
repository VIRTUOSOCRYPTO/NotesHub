# NotesHub Deployment to Render

This document outlines the process to deploy the NotesHub backend to Render.

## Prerequisites

- A [Render](https://render.com) account
- A PostgreSQL database (using Supabase or another provider)
- Firebase project (for authentication)

## Deployment Steps

### 1. Create a PostgreSQL Database

If you haven't already set up a PostgreSQL database:
- You can use Supabase, ElephantSQL, or Render's own PostgreSQL service
- Note the connection details (host, port, username, password, database name)

### 2. Prepare Your Frontend and Backend URLs

Determine the URLs for your frontend and backend deployments:

- Backend API: `https://noteshub-api-gqkp.onrender.com` (or similar)
- Frontend: `https://noteshub-ocpi.onrender.com` (or similar)

Make sure to update all API URL configurations:

- In `.env.production`, set `VITE_API_BASE_URL=https://noteshub-api-gqkp.onrender.com`
- In `client/src/lib/api.ts`, ensure the API URL points to your backend URL
- Update CORS configuration in `server/index.ts` to include both frontend and backend domains

### 3. Deploy Backend Using render.yaml

The easiest way to deploy is using the `render.yaml` file included in this repository:

1. Fork this repository to your GitHub account
2. In your Render dashboard, go to "New" and select "Blueprint"
3. Connect your GitHub account and select the forked repository
4. Render will detect the `render.yaml` file and set up the service

### 4. Configure Environment Variables

After the initial deployment, you'll need to set up the following environment variables in the Render dashboard:

- `DATABASE_URL`: Your PostgreSQL connection string
- `PGHOST`, `PGUSER`, `PGPASSWORD`, `PGDATABASE`, `PGPORT`: Individual PostgreSQL connection details
- `SUPABASE_URL`, `SUPABASE_KEY`: If using Supabase
- `VITE_FIREBASE_API_KEY`, `VITE_FIREBASE_PROJECT_ID`, `VITE_FIREBASE_APP_ID`: Firebase configuration
- `SESSION_SECRET`: Will be auto-generated by Render (using generateValue)
- `NODE_ENV`: Set to `production`
- `PORT`: Set to `10000` (or your preferred port)
- `FORCE_SECURE_COOKIES`: Set to `true`
- `FORCE_HSTS`: Set to `true`

### 5. Manual Deployment

If you prefer to deploy manually:

1. Create a new Web Service in Render named "noteshub-api"
2. Connect to your GitHub repository
3. Configure the service with the following settings:
   - Environment: Node
   - Build Command: `./build.sh`
   - Start Command: `npm start`
   - Add all the environment variables listed above

### 6. Verify Deployment

After deployment:

1. Check the logs in the Render dashboard for any errors
2. Visit the test endpoint at `https://noteshub-api-gqkp.onrender.com/api/test`
3. If everything is working correctly, you will receive a JSON response with a CORS test message

### 7. CORS Configuration

Ensure your CORS settings are correct:

- Your backend should have CORS configured to allow requests from:
  - Your frontend domain (`https://noteshub-ocpi.onrender.com`)
  - Your backend domain (`https://noteshub-api-gqkp.onrender.com`)
  - Any Firebase domain if applicable (`https://notezhubz.web.app` and `https://notezhubz.firebaseapp.com`)

- Content Security Policy and other security headers should also be updated to allow these cross-origin connections

### 8. Session and Cookie Settings

For cross-domain authentication to work properly:

- Ensure `sameSite: 'none'` and `secure: true` are set for cookies in production
- Remove any `domain` restrictions on cookies that might prevent cross-origin functionality

## Common Issues and Solutions

- **Missing Endpoints**: If endpoints like `/api/health` or `/api/db-status` are not working but core functionality is, this is likely due to bundling and code optimization during the build process. As long as your core API endpoints work (users, notes, etc.), this is not a critical issue.
- **CORS Errors**: If you see CORS errors in the browser console, check that the backend CORS configuration includes the frontend domain.
- **Authentication Problems**: Ensure cookies are configured properly for cross-domain authentication.
- **Network Errors**: Make sure your API base URL in the frontend code matches the actual backend URL.
- **Database Connection Errors**: Double-check your PostgreSQL connection details.
- **Cold Start**: Free Render instances sleep after inactivity, the first request may be slow.

## Maintenance

- Monitor your Render logs for errors
- Check Render's dashboard for resource usage
- Consider upgrading to a paid plan for better performance if needed
